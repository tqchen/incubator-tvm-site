

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Relay Pass Infrastructure &mdash; tvm 0.7.dev1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/tvm-logo-square.png"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/tvm_theme.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Adding a Compiler Pass to Relay" href="relay_add_pass.html" />
    <link rel="prev" title="Relay Operator Strategy" href="relay_op_strategy.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/tvm-logo-small.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.7.dev1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../install/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vta/index.html">VTA: Deep Learning Accelerator Stack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/index.html">Deploy and Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/index.html">Contribute to TVM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../langref/index.html">Language Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/python/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_links.html">Links to API References</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Design and Developer Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="runtime.html">TVM Runtime System</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugger.html">Debugger</a></li>
<li class="toctree-l2"><a class="reference internal" href="hybrid_script.html">Hybrid Frontend Developer Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="relay_intro.html">Introduction to Relay IR</a></li>
<li class="toctree-l2"><a class="reference internal" href="relay_add_op.html">Adding an Operator to Relay</a></li>
<li class="toctree-l2"><a class="reference internal" href="relay_op_strategy.html">Relay Operator Strategy</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Relay Pass Infrastructure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-design">The Design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#c-backend">C++ Backend</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pass-registration">Pass Registration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#python-frontend">Python Frontend</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debugging">Debugging</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="relay_add_pass.html">Adding a Compiler Pass to Relay</a></li>
<li class="toctree-l2"><a class="reference internal" href="relay_bring_your_own_codegen.html">Bring Your Own Codegen To TVM</a></li>
<li class="toctree-l2"><a class="reference internal" href="virtual_machine.html">Putting the VM in TVM: The Relay Virtual Machine</a></li>
<li class="toctree-l2"><a class="reference internal" href="codebase_walkthrough.html">TVM Codebase Walkthrough by Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="convert_layout.html">Convert Layout Pass</a></li>
<li class="toctree-l2"><a class="reference internal" href="inferbound.html">InferBound Pass</a></li>
<li class="toctree-l2"><a class="reference internal" href="benchmark.html">Benchmark Performance Log Format</a></li>
<li class="toctree-l2"><a class="reference internal" href="introduction_to_module_serialization.html">Introduction to Module Serialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">Security</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../frontend/tensorflow.html">TensorFlow Frontend</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../genindex.html">Index</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tvm</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Design and Developer Guide</a> &raquo;</li>
        
      <li>Relay Pass Infrastructure</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/dev/relay_pass_infra.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="relay-pass-infrastructure">
<span id="relay-pass-infra"></span><h1>Relay Pass Infrastructure<a class="headerlink" href="#relay-pass-infrastructure" title="Permalink to this headline">Â¶</a></h1>
<p>Relay features a series of optimization passes which improve performance metrics
of models such as mean inference, memory footprint, or power consumption for
specific devices. There is a suite of standard optimizations as well as machine
learning-specific optimizations including constant folding, dead code
elimination, operator layout alteration, and operator fusion, etc. Each of these
passes is structured as a Relay-to-Relay transformation on the abstract syntax
tree (AST) using the analysis result collected during and/or before traversal.</p>
<p>However, as Relay evolves quickly, the need for a more systematic and efficient
way to manage these passes is becoming apparent. This doc describes the design of
such an infra that takes the advantage of the way production compilers are used to
manage the optimization passes and the style modern deep learning frameworks
adopted to build up layers.</p>
<p>For example, many existing production compilers, such as GCC and LLVM, employ
pass managers to effectively manage the execution of passes. Initially managing
passes is straightforward as the number of passes is small, but mature compilers
will contain hundreds of individual passes. Often external users will want to
have custom passes correctly scheduled without having to modify a single
handcrafted pass order.</p>
<p>Similarly, modern deep learning frameworks, such as Pytorch and MXNet
Gluon, also have the tendency to enable pass-style layer construction
scheme through <a class="reference external" href="https://pytorch.org/docs/stable/nn.html?highlight=sequential#torch.nn.Sequential">Sequential</a> and <a class="reference external" href="https://mxnet.incubator.apache.org/api/python/docs/api/gluon/block.html#gluon-block">Block</a>, respectively. With such constructs,
these modern frameworks are able to conveniently add modules/layers to their
containers and build up neural networks easily.</p>
<p>The design of the Relay pass infra is largely inspired by the the hierarchical
pass manager used in LLVM and the block-style containers used in the popular
deep learning frameworks. The major goals of the pass infra include:</p>
<ol class="arabic simple">
<li><p>enabling better programmatic orchestration of optimizations. This allows
users to flexibly customize and build their own optimization pipelines.</p></li>
<li><p>providing a user-friendly way to debug optimization passes.</p></li>
<li><p>alleviating developers from manually and respectively resolving the
dependencies between passes.</p></li>
<li><p>simplifying the implementation of new passes for developers. For example, we
allow users to implement a pass in Python and let the pass infra manipulate
its execution.</p></li>
</ol>
<div class="section" id="the-design">
<h2>The Design<a class="headerlink" href="#the-design" title="Permalink to this headline">Â¶</a></h2>
<p>We focus on ease of extension for users, making it possible for users to quickly
add new passes without loss of backward compatibility. The design contains both
the backend and the frontend. The former implements the main logic of the pass
infra. The latter provides simple APIs for users to interact with, i.e.,
allowing users to quickly create their own optimization pipelines.</p>
<div class="section" id="c-backend">
<h3>C++ Backend<a class="headerlink" href="#c-backend" title="Permalink to this headline">Â¶</a></h3>
<p>We provide a <code class="docutils literal notranslate"><span class="pre">PassInfo</span></code> object to contain the basic information needed by
a pass. <code class="docutils literal notranslate"><span class="pre">name</span></code> is the pass name, <code class="docutils literal notranslate"><span class="pre">opt_level</span></code> indicates at which optimization
level the pass will be enabled, and <code class="docutils literal notranslate"><span class="pre">required</span></code> represents the passes that are
required to execute a certain pass (see <a class="reference external" href="https://github.com/apache/incubator-tvm/blob/master/include/tvm/ir/transform.h">include/tvm/ir/transform.h</a> for
more details). For example, during registration of a pass (will be covered in
later), the pass developers can specify the name of the pass, the optimization
level it will be performed at, and/or the passes that are required.
<code class="docutils literal notranslate"><span class="pre">opt_level</span></code> could be used to help the pass infra identify if a certain pass
needs to be executed when running under a user-provided optimization level. The
<code class="docutils literal notranslate"><span class="pre">required</span></code> field can be used by the pass infra to resolve pass dependencies.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PassInfoNode</span> <span class="o">:</span> <span class="k">public</span> <span class="n">RelayNode</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">opt_level</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">required</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="section" id="passcontext">
<h4>PassContext<a class="headerlink" href="#passcontext" title="Permalink to this headline">Â¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">PassContext</span></code> carries useful information for an optimization pass. For
example, it contains the error reporting system so optimization authors can
provide diagnostics about why an optimization fails. <code class="docutils literal notranslate"><span class="pre">PassContext</span></code> is also
designed to replace the old <code class="docutils literal notranslate"><span class="pre">BuildConfig</span></code> which was used to help users
configure the compilation options, including optimization level and
required/disabled passes, etc. For instance, we may have a configuration which
performs all passes at <code class="docutils literal notranslate"><span class="pre">opt_level=3</span></code> with some disabled passes using
<code class="docutils literal notranslate"><span class="pre">disabled_pass=xx</span></code> provided by <code class="docutils literal notranslate"><span class="pre">PassContext</span></code>. Now we could glob all passes
at <code class="docutils literal notranslate"><span class="pre">opt_level=3</span></code> and exclude those in the disabled pass list.</p>
<p>This class is designed for users to conveniently write the Python <code class="docutils literal notranslate"><span class="pre">with</span></code>
syntax to perform optimizations under a certain configuration. In addition, the
users can obtain the context that is available within a certain program scope in
a thread-safe way through <code class="docutils literal notranslate"><span class="pre">PassContext::Current()</span></code>, since a thread-local store
<code class="docutils literal notranslate"><span class="pre">RelayPassContextThreadLocalStore</span></code> is used to hold the created pass context
objects. Examples will be provided later to show how we can use both the C++ and
Python APIs to create a compilation pipeline using pass context.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PassContextNode</span> <span class="o">:</span> <span class="k">public</span> <span class="n">RelayNode</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">ErrorReporter</span> <span class="n">err_reporter</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">opt_level</span><span class="p">{</span><span class="mi">2</span><span class="p">};</span>
  <span class="kt">int</span> <span class="n">fallback_device</span><span class="p">{</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kDLCPU</span><span class="p">)};</span>
  <span class="n">tvm</span><span class="o">::</span><span class="n">Array</span><span class="o">&lt;</span><span class="n">tvm</span><span class="o">::</span><span class="n">Expr</span><span class="o">&gt;</span> <span class="n">required_pass</span><span class="p">;</span>
  <span class="n">tvm</span><span class="o">::</span><span class="n">Array</span><span class="o">&lt;</span><span class="n">tvm</span><span class="o">::</span><span class="n">Expr</span><span class="o">&gt;</span> <span class="n">disabled_pass</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">PassContext</span> <span class="o">:</span> <span class="k">public</span> <span class="n">NodeRef</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">TVM_DLL</span> <span class="k">static</span> <span class="n">PassContext</span> <span class="n">Create</span><span class="p">();</span>
  <span class="n">TVM_DLL</span> <span class="k">static</span> <span class="n">PassContext</span> <span class="nf">Current</span><span class="p">();</span>
  <span class="cm">/* Other fields are omitted. */</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="c1">// The entry of a pass context scope.</span>
  <span class="n">TVM_DLL</span> <span class="kt">void</span> <span class="n">EnterWithScope</span><span class="p">();</span>
  <span class="c1">// The exit of a pass context scope.</span>
  <span class="n">TVM_DLL</span> <span class="kt">void</span> <span class="nf">ExitWithScope</span><span class="p">();</span>

  <span class="c1">// Classes to get the Python `with` like syntax.</span>
  <span class="k">friend</span> <span class="k">class</span> <span class="nc">tvm</span><span class="o">::</span><span class="n">With</span><span class="o">&lt;</span><span class="n">PassContext</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">RelayPassContextThreadLocalEntry</span> <span class="p">{</span>
  <span class="cm">/*! \brief The default pass context. */</span>
  <span class="n">PassContext</span> <span class="n">default_context</span><span class="p">;</span>
  <span class="cm">/*! \brief The current pass context. */</span>
  <span class="n">std</span><span class="o">::</span><span class="n">stack</span><span class="o">&lt;</span><span class="n">PassContext</span><span class="o">&gt;</span> <span class="n">context_stack</span><span class="p">;</span>
  <span class="n">RelayPassContextThreadLocalEntry</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">default_context</span> <span class="o">=</span> <span class="n">PassContext</span><span class="p">(</span><span class="n">make_node</span><span class="o">&lt;</span><span class="n">PassContextNode</span><span class="o">&gt;</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*! \brief The thread-local store to hold the pass context. */</span>
<span class="k">typedef</span> <span class="n">dmlc</span><span class="o">::</span><span class="n">ThreadLocalStore</span><span class="o">&lt;</span><span class="n">RelayPassContextThreadLocalEntry</span><span class="o">&gt;</span>
     <span class="n">RelayPassContextThreadLocalStore</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="pass-constructs">
<h4>Pass Constructs<a class="headerlink" href="#pass-constructs" title="Permalink to this headline">Â¶</a></h4>
<p>The pass infra is designed in a hierarchical manner, and it could work at
different granularities of Relay programs. A pure virtual class <code class="docutils literal notranslate"><span class="pre">PassNode</span></code> is
introduced to serve as the base of the different optimization passes. This class
contains several virtual methods that must be implemented by the
subclasses at the level of modules, functions, or sequences of passes..</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PassNode</span> <span class="o">:</span> <span class="n">RelayNode</span> <span class="p">{</span>
  <span class="k">virtual</span> <span class="n">PassInfo</span> <span class="n">Info</span><span class="p">()</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="n">Module</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">Module</span><span class="o">&amp;</span> <span class="n">mod</span>
                            <span class="k">const</span> <span class="n">PassContext</span><span class="o">&amp;</span> <span class="n">pass_ctx</span><span class="p">)</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The functor shows how a pass must be realized, i.e. it always works on a <a class="reference external" href="https://docs.tvm.ai/langref/relay_expr.html#module-and-global-functions">Relay
module</a> under a certain context. All passes are designed in a <code class="docutils literal notranslate"><span class="pre">Module</span></code> to <code class="docutils literal notranslate"><span class="pre">Module</span></code>
manner. Therefore, optimizations governed by the pass infra will
always update the whole module.</p>
<p>Several subclasses have been created to implement different types of
optimization passes, e.g., function-level passes, module-level passes, and
sequential passes.  Each subclass itself could act as a pass manager. For
instance, they could collect the required passes and execute them or build
a dependency graph based on the given metadata. The full definition of them
can be found in <a class="reference external" href="https://github.com/apache/incubator-tvm/blob/master/src/relay/ir/transform.cc">src/relay/ir/transform.cc</a> and <a class="reference external" href="https://github.com/apache/incubator-tvm/blob/master/src/ir/transform.cc">src/ir/transform.cc</a>.</p>
</div>
<div class="section" id="module-level-passes">
<h4>Module-Level Passes<a class="headerlink" href="#module-level-passes" title="Permalink to this headline">Â¶</a></h4>
<p>Module level passes are geared mainly for global and inter-procedural
optimizations (IPO), which are similar to the module pass used in LLVM. Some
typical passes in Relay that need the global picture of a module, such as
A-normal form conversion and lambda lifting, etc., fall into this set. At this
level, users can even add and/or delete functions in a module.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ModulePassNode</span> <span class="o">:</span> <span class="n">PassNode</span> <span class="p">{</span>
  <span class="n">PassInfo</span> <span class="n">pass_info</span><span class="p">;</span>
  <span class="n">runtime</span><span class="o">::</span><span class="n">TypedPackedFunc</span><span class="o">&lt;</span><span class="n">Module</span><span class="p">(</span><span class="n">Module</span><span class="p">,</span> <span class="n">PassContext</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">pass_func</span><span class="p">;</span>
  <span class="n">Module</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">Module</span><span class="o">&amp;</span> <span class="n">mod</span><span class="p">,</span> <span class="k">const</span> <span class="n">PassContext</span><span class="o">&amp;</span> <span class="n">pass_ctx</span><span class="p">)</span> <span class="k">const</span> <span class="k">final</span><span class="p">;</span>
  <span class="c1">// Other members/methods are omitted</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pass_info</span></code> maintains the information needed by a module-level pass.
<code class="docutils literal notranslate"><span class="pre">pass_func</span></code> sketches the real optimization. For example, we may need to
perform dead code elimination on the module. We could implement the algorithm in
the <code class="docutils literal notranslate"><span class="pre">pass_func</span></code> and let it run on a module. It will then remove the dead code
including the unused functions in the module. Note that this field is designed
as a packed function, which enables the implementation of the optimization in
both C++ and Python.</p>
</div>
<div class="section" id="function-level-passes">
<h4>Function-Level Passes<a class="headerlink" href="#function-level-passes" title="Permalink to this headline">Â¶</a></h4>
<p>Function-level passes are used to implement various intra-function level
optimizations for a given Relay module. It fetches one function at a time from
the function list of a module for optimization and yields a rewritten Relay
function. Most of Relayâs passes can be classified into this category, such as
common subexpression elimination and inference simplification, etc.</p>
<p>Note that the scope of passes at this level is a Relay function. Therefore, we
cannot add or delete a function through these passes as they are not aware of
the global information.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span class="k">class</span> <span class="nc">FunctionPassNode</span> <span class="o">:</span> <span class="n">PassNode</span> <span class="p">{</span>
  <span class="n">PassInfo</span> <span class="n">pass_info</span><span class="p">;</span>
  <span class="n">runtime</span><span class="o">::</span><span class="n">TypedPackedFunc</span><span class="o">&lt;</span><span class="n">Function</span><span class="p">(</span><span class="n">Function</span><span class="p">,</span> <span class="n">Module</span><span class="p">,</span> <span class="n">PassContext</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">pass_func</span><span class="p">;</span>
  <span class="n">Module</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">Module</span><span class="o">&amp;</span> <span class="n">mod</span><span class="p">,</span> <span class="k">const</span> <span class="n">PassContext</span><span class="o">&amp;</span> <span class="n">pass_ctx</span><span class="p">)</span> <span class="k">const</span> <span class="k">final</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="nf">SkipFunction</span><span class="p">(</span><span class="k">const</span> <span class="n">Function</span><span class="o">&amp;</span> <span class="n">func</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
  <span class="c1">// Other members/methods are omitted...</span>
<span class="p">};</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">pass_info</span></code> is identical to what we just described in the module pass.
<code class="docutils literal notranslate"><span class="pre">pass_func</span></code> takes a function for optimization, it also needs a module as we
may use it for reporting errors. A function could be annotated with
âSkipOptimizationâ so that it will be ignored during optimization.</p>
</div>
<div class="section" id="sequential-passes">
<h4>Sequential Passes<a class="headerlink" href="#sequential-passes" title="Permalink to this headline">Â¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">SequentialPass</span></code> is similar to Pytorch <code class="docutils literal notranslate"><span class="pre">nn.Sequential</span></code> that contains a host
of passes for execution.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SequentialPassNode</span> <span class="o">:</span> <span class="n">PassNode</span> <span class="p">{</span>
  <span class="n">PassInfo</span> <span class="n">pass_info</span><span class="p">;</span>
  <span class="c1">// Passes need to be executed.</span>
  <span class="n">Array</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span> <span class="n">passes</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="nf">PassEnabled</span><span class="p">(</span><span class="k">const</span> <span class="n">PassInfo</span><span class="o">&amp;</span> <span class="n">info</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
  <span class="n">Module</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">Module</span><span class="o">&amp;</span> <span class="n">mod</span><span class="p">,</span> <span class="k">const</span> <span class="n">PassContext</span><span class="o">&amp;</span> <span class="n">pass_ctx</span><span class="p">)</span> <span class="k">const</span> <span class="k">final</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Only a few passes currently in Relay are put in this group. For example,
<code class="docutils literal notranslate"><span class="pre">FoldScaleAxis</span></code> requires to dispatch <code class="docutils literal notranslate"><span class="pre">ForwardFoldScaleAxis</span></code> and
<code class="docutils literal notranslate"><span class="pre">BackwardFoldScaleAxis</span></code> internally. In addition, <code class="docutils literal notranslate"><span class="pre">BackwardFoldScaleAxis</span></code> is
recommended to be fulfilled first. This pass, hence, is an ideal candidate for
<code class="docutils literal notranslate"><span class="pre">SequentialPass</span></code>.</p>
<p>The following code shows how individual passes in a sequential pass are invoked.
Essentially, we sequentially execute each pass in a sequential pass using the
order that they were appended to the pass list.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span class="n">Module</span> <span class="n">SequentialNode</span><span class="o">::</span><span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">Module</span><span class="o">&amp;</span> <span class="n">module</span><span class="p">,</span>
                                  <span class="k">const</span> <span class="n">PassContext</span><span class="o">&amp;</span> <span class="n">pass_ctx</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">Module</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">module</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">Pass</span><span class="o">&amp;</span> <span class="nl">pass</span> <span class="p">:</span> <span class="n">passes</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">CHECK</span><span class="p">(</span><span class="n">pass</span><span class="p">.</span><span class="n">defined</span><span class="p">())</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Found undefined pass for optimization.&quot;</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">PassInfo</span><span class="o">&amp;</span> <span class="n">pass_info</span> <span class="o">=</span> <span class="n">pass</span><span class="o">-&gt;</span><span class="n">Info</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PassEnabled</span><span class="p">(</span><span class="n">pass_info</span><span class="p">))</span>  <span class="k">continue</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">it</span> <span class="p">:</span> <span class="n">pass_info</span><span class="o">-&gt;</span><span class="n">required</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const</span> <span class="k">auto</span><span class="o">*</span> <span class="n">name</span> <span class="o">=</span> <span class="n">it</span><span class="p">.</span><span class="n">as</span><span class="o">&lt;</span><span class="n">tvm</span><span class="o">::</span><span class="n">ir</span><span class="o">::</span><span class="n">StringImm</span><span class="o">&gt;</span><span class="p">();</span>
      <span class="n">CHECK</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
      <span class="n">mod</span> <span class="o">=</span> <span class="n">GetPass</span><span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)(</span><span class="n">mod</span><span class="p">,</span> <span class="n">pass_ctx</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">pass</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">pass_ctx</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">mod</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Upon the invocation of a pass, we first check if this pass is enabled. This is
done by first checking if the pass is explicitly disabled by a user, followed by
inspecting if it is specified as a required pass by the user. If it is still
undetermined whether this pass is enabled, its <code class="docutils literal notranslate"><span class="pre">opt_level</span></code> will be checked.
This pass will be enabled and therefore executed only when its optimization
level is not less than the configured optimization level in the pass context.</p>
<p>To execute the pass, we need first to retrieve the registered pass in the TVM
packed function registry using the pass name. This is possible because every
pass is registered with an API endpoint as we will show later.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span class="n">Pass</span> <span class="nf">GetPass</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">pass_name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">using</span> <span class="n">tvm</span><span class="o">::</span><span class="n">runtime</span><span class="o">::</span><span class="n">Registry</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">fpass_name</span> <span class="o">=</span> <span class="s">&quot;relay._transform.&quot;</span> <span class="o">+</span> <span class="n">pass_name</span><span class="p">;</span>
  <span class="k">const</span> <span class="k">auto</span><span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="n">Registry</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="n">fpass_name</span><span class="p">);</span>
  <span class="n">CHECK</span><span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Cannot find &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">fpass_name</span>
                      <span class="o">&lt;&lt;</span> <span class="s">&quot;to create the pass &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">pass_name</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Some helper functions are provided to create each type of these aforementioned
passes. These helpers are also exposed to the Python frontend for users to
favorably use Python APIs to create a specific pass object.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span class="n">FunctionPass</span> <span class="nf">CreateFunctionPass</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span>
                                <span class="kt">int</span> <span class="n">opt_level</span><span class="p">,</span>
                                <span class="n">PassFunc</span> <span class="n">pass_func</span><span class="p">);</span>

<span class="n">ModulePass</span> <span class="nf">CreateModulePass</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span>
                            <span class="kt">int</span> <span class="n">opt_level</span><span class="p">,</span>
                            <span class="n">PassFunc</span> <span class="n">pass_func</span><span class="p">);</span>

<span class="n">SequentialPass</span> <span class="nf">CreateSequentialPass</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span>
                                    <span class="kt">int</span> <span class="n">opt_level</span><span class="p">,</span>
                                    <span class="n">Array</span><span class="o">&lt;</span><span class="n">Pass</span><span class="o">&gt;</span> <span class="n">passes</span><span class="p">,</span>
                                    <span class="n">Array</span><span class="o">&lt;</span><span class="n">tvm</span><span class="o">::</span><span class="n">Expr</span><span class="o">&gt;</span> <span class="n">disabled</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="c-sequential-example">
<h4>C++ Sequential Example<a class="headerlink" href="#c-sequential-example" title="Permalink to this headline">Â¶</a></h4>
<p>Letâs now take an example to illustrate how the pass infra works on
<code class="docutils literal notranslate"><span class="pre">SequentialPass</span></code>. For illustrative purpose, only a code snippet is provided.
First, we create a simple Relay program, <code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">f(x)</span></code>. Then, we build a module
based on the function. After creating the module, we instantiate a sequential
pass object which contains some standard Relay optimization passes, including
type inference, dead code elimination, common subexpression elimination, and
layout alteration.</p>
<p>Finally, a pass context is constructed and the passes will be executed
sequentially. During the execution of these passes, the pass dependency will be
resolved automatically as we have encoded the dependent passes during
registration.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span class="c1">// Create a simple Relay program.</span>
<span class="k">auto</span> <span class="n">tensor_type</span> <span class="o">=</span> <span class="n">relay</span><span class="o">::</span><span class="n">TensorTypeNode</span><span class="o">::</span><span class="n">make</span><span class="p">({},</span> <span class="n">tvm</span><span class="o">::</span><span class="n">Bool</span><span class="p">());</span>
<span class="k">auto</span> <span class="n">x</span> <span class="o">=</span> <span class="n">relay</span><span class="o">::</span><span class="n">VarNode</span><span class="o">::</span><span class="n">make</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="n">relay</span><span class="o">::</span><span class="n">Type</span><span class="p">());</span>
<span class="k">auto</span> <span class="n">f</span> <span class="o">=</span> <span class="n">relay</span><span class="o">::</span><span class="n">FunctionNode</span><span class="o">::</span><span class="n">make</span><span class="p">(</span><span class="n">tvm</span><span class="o">::</span><span class="n">Array</span><span class="o">&lt;</span><span class="n">relay</span><span class="o">::</span><span class="n">Var</span><span class="o">&gt;</span><span class="p">{</span> <span class="n">x</span> <span class="p">},</span> <span class="n">x</span><span class="p">,</span> <span class="n">relay</span><span class="o">::</span><span class="n">Type</span><span class="p">(),</span> <span class="p">{});</span>

<span class="k">auto</span> <span class="n">y</span> <span class="o">=</span> <span class="n">relay</span><span class="o">::</span><span class="n">VarNode</span><span class="o">::</span><span class="n">make</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="n">tensor_type</span><span class="p">);</span>
<span class="k">auto</span> <span class="n">call</span> <span class="o">=</span> <span class="n">relay</span><span class="o">::</span><span class="n">CallNode</span><span class="o">::</span><span class="n">make</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">tvm</span><span class="o">::</span><span class="n">Array</span><span class="o">&lt;</span><span class="n">relay</span><span class="o">::</span><span class="n">Expr</span><span class="o">&gt;</span><span class="p">{</span> <span class="n">y</span> <span class="p">});</span>
<span class="k">auto</span> <span class="n">fx</span> <span class="o">=</span> <span class="n">relay</span><span class="o">::</span><span class="n">FunctionNode</span><span class="o">::</span><span class="n">make</span><span class="p">(</span><span class="n">tvm</span><span class="o">::</span><span class="n">Array</span><span class="o">&lt;</span><span class="n">relay</span><span class="o">::</span><span class="n">Var</span><span class="o">&gt;</span><span class="p">{</span> <span class="n">y</span> <span class="p">},</span> <span class="n">call</span><span class="p">,</span> <span class="n">relay</span><span class="o">::</span><span class="n">Type</span><span class="p">(),</span> <span class="p">{});</span>

<span class="c1">// Create a module for optimization.</span>
<span class="k">auto</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">IRModule</span><span class="o">::</span><span class="n">FromExpr</span><span class="p">(</span><span class="n">fx</span><span class="p">);</span>

<span class="c1">// Create a sequential pass.</span>
<span class="n">tvm</span><span class="o">::</span><span class="n">Array</span><span class="o">&lt;</span><span class="n">relay</span><span class="o">::</span><span class="n">transform</span><span class="o">::</span><span class="n">Pass</span><span class="o">&gt;</span> <span class="n">pass_seqs</span><span class="p">{</span>
   <span class="n">relay</span><span class="o">::</span><span class="n">transform</span><span class="o">::</span><span class="n">InferType</span><span class="p">(),</span>
   <span class="n">relay</span><span class="o">::</span><span class="n">transform</span><span class="o">::</span><span class="n">DeadCodeElimination</span><span class="p">(),</span>
   <span class="n">relay</span><span class="o">::</span><span class="n">transform</span><span class="o">::</span><span class="n">EliminateCommonSubexpr</span><span class="p">(),</span>
   <span class="n">relay</span><span class="o">::</span><span class="n">transform</span><span class="o">::</span><span class="n">AlterOpLayout</span><span class="p">()</span>
<span class="p">};</span>
<span class="n">relay</span><span class="o">::</span><span class="n">transform</span><span class="o">::</span><span class="n">Pass</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">relay</span><span class="o">::</span><span class="n">transform</span><span class="o">::</span><span class="n">Sequential</span><span class="p">(</span><span class="n">pass_seqs</span><span class="p">);</span>

<span class="c1">// Create a pass context for the optimization.</span>
<span class="k">auto</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">relay</span><span class="o">::</span><span class="n">transform</span><span class="o">::</span><span class="n">PassContext</span><span class="o">::</span><span class="n">Create</span><span class="p">();</span>
<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">opt_level</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fallback_device</span> <span class="o">=</span> <span class="n">kDLCPU</span><span class="p">;</span>

<span class="c1">// Use the Python with syntax to execute the sequence of optimizations.</span>
<span class="n">tvm</span><span class="o">::</span><span class="n">With</span><span class="o">&lt;</span><span class="n">relay</span><span class="o">::</span><span class="n">transform</span><span class="o">::</span><span class="n">PassContext</span><span class="o">&gt;</span> <span class="n">scope</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="n">mod</span> <span class="o">=</span> <span class="n">seq</span><span class="p">(</span><span class="n">mod</span><span class="p">);</span>

<span class="c1">// View the updated module.</span>
<span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">relay</span><span class="o">::</span><span class="n">AsText</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</pre></div>
</div>
<p>Other types of passes should be directly invoked for execution on a module. For
example, users can directly apply const folding pass on a given module, <code class="docutils literal notranslate"><span class="pre">mod</span>
<span class="pre">=</span> <span class="pre">transform::FoldConstant()(mod)</span></code>. However, it is usersâ responsibility to
execute the required passes explicitly.</p>
</div>
</div>
<div class="section" id="pass-registration">
<h3>Pass Registration<a class="headerlink" href="#pass-registration" title="Permalink to this headline">Â¶</a></h3>
<p>Weâve covered the concept of different level of passes and the context used for
compilation. It would be interesting to see how easily users can register
a pass.  Letâs take const folding as an example. This pass has already been
implemented to fold constants in a Relay function (found in
<a class="reference external" href="https://github.com/apache/incubator-tvm/blob/master/src/relay/pass/fold_constant.cc">src/relay/pass/fold_constant.cc</a>).</p>
<p>An API was provided to perform the <code class="docutils literal notranslate"><span class="pre">Expr</span></code> to <code class="docutils literal notranslate"><span class="pre">Expr</span></code> transformation.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span class="n">Expr</span> <span class="nf">FoldConstant</span><span class="p">(</span><span class="k">const</span> <span class="n">Expr</span><span class="o">&amp;</span> <span class="n">expr</span><span class="p">);</span>
</pre></div>
</div>
<p>In order to register this pass to the pass infra, we first need to decide at
which level this pass will be performed. As const folding happens on individual
functions, we should intuitively create a <code class="docutils literal notranslate"><span class="pre">FunctionPass</span></code> for it through
<code class="docutils literal notranslate"><span class="pre">CreateFunctionPass</span></code>. The <code class="docutils literal notranslate"><span class="pre">pass_func</span></code> is returned as a packed function that
invokes the <code class="docutils literal notranslate"><span class="pre">Expr</span></code> to <code class="docutils literal notranslate"><span class="pre">Expr</span></code> API on each function in a Relay module. <code class="docutils literal notranslate"><span class="pre">{}</span></code>
indicates that no prerequisite is required for this pass. Otherwise, the pass
developer has to identify and list them.</p>
<p>Meanwhile, a pass API endpoint is registered with the name
<code class="docutils literal notranslate"><span class="pre">relay._transform.FoldConstant</span></code>. This pass, therefore, becomes an entry in the
registry that can be accessed by both C++ (e.g. the <code class="docutils literal notranslate"><span class="pre">GetPass</span></code> above) and
Python when needed.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span class="k">namespace</span> <span class="n">transform</span> <span class="p">{</span>

<span class="n">Pass</span> <span class="n">FoldConstant</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">runtime</span><span class="o">::</span><span class="n">TypedPackedFunc</span><span class="o">&lt;</span><span class="n">Function</span><span class="p">(</span><span class="n">Function</span><span class="p">,</span> <span class="n">Module</span><span class="p">,</span> <span class="n">PassContext</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">pass_func</span> <span class="o">=</span>
    <span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="n">Function</span> <span class="n">f</span><span class="p">,</span> <span class="n">Module</span> <span class="n">m</span><span class="p">,</span> <span class="n">PassContext</span> <span class="n">pc</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">Downcast</span><span class="o">&lt;</span><span class="n">Function</span><span class="o">&gt;</span><span class="p">(</span><span class="n">FoldConstant</span><span class="p">(</span><span class="n">f</span><span class="p">));</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="nf">CreateFunctionPass</span><span class="p">(</span><span class="n">pass_func</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;FoldConstant&quot;</span><span class="p">,</span> <span class="p">{});</span>
<span class="p">}</span>

<span class="n">TVM_REGISTER_GLOBAL</span><span class="p">(</span><span class="s">&quot;relay._transform.FoldConstant&quot;</span><span class="p">)</span>
<span class="p">.</span><span class="n">set_body_typed</span><span class="p">(</span><span class="n">FoldConstant</span><span class="p">);</span>

<span class="p">}</span>  <span class="c1">// namespace transform</span>
</pre></div>
</div>
<p>To allow other C++ modules to apply this pass, we declare a free function in
<a class="reference external" href="https://github.com/apache/incubator-tvm/blob/master/include/tvm/relay/transform.h">include/tvm/relay/transform.h</a> as the following:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span class="n">TVM_DLL</span> <span class="n">Pass</span> <span class="nf">FoldConstant</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="python-frontend">
<h3>Python Frontend<a class="headerlink" href="#python-frontend" title="Permalink to this headline">Â¶</a></h3>
<p>Only some simple APIs are needed for the frontend side. For example, we can
provide users the following APIs to create and execute a pass (full
implementation is provided in <a class="reference external" href="https://github.com/apache/incubator-tvm/blob/master/python/tvm/relay/transform.py">python/tvm/relay/transform.py</a>). The backend
receives the information and decides which function it should use to create
a Pass object.</p>
<div class="section" id="id1">
<h4>PassContext<a class="headerlink" href="#id1" title="Permalink to this headline">Â¶</a></h4>
<p>Python frontend provides a wrapper for the <code class="docutils literal notranslate"><span class="pre">PassContext</span></code> to enable the
<code class="docutils literal notranslate"><span class="pre">with</span></code> syntax by overriding <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code>. A <code class="docutils literal notranslate"><span class="pre">current</span></code>
static method is offered for users to get the context that is in use under
a certain scope.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span class="nd">@register_relay_node</span>
<span class="k">class</span> <span class="nc">PassContext</span><span class="p">(</span><span class="n">RelayNode</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_transform</span><span class="o">.</span><span class="n">EnterPassContext</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">trace</span><span class="p">):</span>
        <span class="n">_transform</span><span class="o">.</span><span class="n">ExitPassContext</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">current</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Return the current pass context.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_transform</span><span class="o">.</span><span class="n">GetCurrentPassContext</span><span class="p">()</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">PassContext</span></code> object can be instantiated through the <code class="docutils literal notranslate"><span class="pre">build_config</span></code> API
which was used by Relay to configure the compilation options, including the
optimization level, fallback device for heterogeneous execution, and
required/disabled passes.</p>
</div>
<div class="section" id="pass-objects">
<h4>Pass Objects<a class="headerlink" href="#pass-objects" title="Permalink to this headline">Â¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Pass</span></code> is the base class of all pass objects. All methods here are just simple
wrappers that were implemented in the backend. They are defined for users to
conveniently interact with the base class in Python. Only a <code class="docutils literal notranslate"><span class="pre">__call__</span></code> is
defined in the pass base class to make the subclasses as callable objects so
that they can be invoked easily (e.g., <code class="docutils literal notranslate"><span class="pre">pass_xx(arg)</span></code>) for execution.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span class="nd">@register_relay_node</span>
<span class="k">class</span> <span class="nc">Pass</span><span class="p">(</span><span class="n">RelayNode</span><span class="p">):</span>
   <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span>
       <span class="k">return</span> <span class="n">_transform</span><span class="o">.</span><span class="n">RunPass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>
</pre></div>
</div>
<p>Some auxiliary APIs are provided to enable easy creation of passes from
the Python frontend and to let the pass infra control the execution. For
example, <code class="docutils literal notranslate"><span class="pre">module_pass</span></code>, <code class="docutils literal notranslate"><span class="pre">function_pass</span></code>, and <code class="docutils literal notranslate"><span class="pre">sequential</span></code> are provided to
users so that they can customize their own pass or pass pipeline.</p>
<p>For all the passes that are implemented in the C++ backend, we provide
a corresponding Python API in <a class="reference external" href="https://github.com/apache/incubator-tvm/blob/master/python/tvm/relay/transform.py">python/tvm/relay/transform.py</a>. For instance,
const folding has a Python API like the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span class="k">def</span> <span class="nf">FoldConstant</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_transform</span><span class="o">.</span><span class="n">FoldConstant</span><span class="p">()</span>
</pre></div>
</div>
<p>Users can build a pass through decoration like the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre> <span class="nd">@relay.transform.module_pass</span><span class="p">(</span><span class="n">opt_level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
    <span class="n">tp</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">TensorType</span><span class="p">((</span><span class="mi">10</span><span class="p">,),</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">tp</span><span class="p">)</span>
    <span class="n">gv</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">GlobalVar</span><span class="p">(</span><span class="s2">&quot;abs&quot;</span><span class="p">)</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">Function</span><span class="p">([</span><span class="n">x</span><span class="p">],</span> <span class="n">relay</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">new_mod</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">Module</span><span class="p">({</span><span class="n">gv</span><span class="p">:</span> <span class="n">func</span><span class="p">})</span>
    <span class="n">new_mod</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_mod</span>

<span class="n">module_pass</span> <span class="o">=</span> <span class="n">transform</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module_pass</span><span class="p">,</span> <span class="n">transform</span><span class="o">.</span><span class="n">ModulePass</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">module_pass</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">opt_level</span> <span class="o">==</span> <span class="mi">2</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">transform</span></code> function here adds an <code class="docutils literal notranslate"><span class="pre">abs</span></code> function to the input module,
but it could be any customized optimizations at the module level. After
creating this <code class="docutils literal notranslate"><span class="pre">module_pass</span></code>, users can apply it on any Relay module. For
example, we can build an empty module and apply this pass to add an <code class="docutils literal notranslate"><span class="pre">abs</span></code>
function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span class="n">mod</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">Module</span><span class="p">()</span>
<span class="n">mod</span> <span class="o">=</span> <span class="n">module_pass</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
</pre></div>
</div>
<p>Correspondingly, we also offer such functionality for <code class="docutils literal notranslate"><span class="pre">function_pass</span></code>. For
instance, an example function-level pass could be written as the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span class="nd">@relay.transform.function_pass</span><span class="p">(</span><span class="n">opt_level</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestReplaceFunc</span><span class="p">:</span>
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_func</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">new_func</span> <span class="o">=</span> <span class="n">new_func</span>
      <span class="k">def</span> <span class="nf">transform_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
         <span class="c1"># Just for demo purposes</span>
         <span class="c1"># Transform func to new_func</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_func</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">f1</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">Function</span><span class="p">([</span><span class="n">x</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
<span class="n">f2</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">Function</span><span class="p">([</span><span class="n">x</span><span class="p">],</span> <span class="n">relay</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="c1"># fpass is now a special pass that replaces every</span>
<span class="c1"># function to f1</span>
<span class="n">fpass</span> <span class="o">=</span> <span class="n">TestReplaceFunc</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span>
<span class="c1"># Now every function in input_mod is replaced by f1</span>
<span class="n">res_mod</span> <span class="o">=</span> <span class="n">fpass</span><span class="p">(</span><span class="n">input_mod</span><span class="p">)</span>
</pre></div>
</div>
<p>Alternatively, users can also directly register a pass without using the
decorators and then invoke it. Letâs use <code class="docutils literal notranslate"><span class="pre">Sequential</span></code> to demo this scenario.</p>
</div>
<div class="section" id="python-sequential-example">
<h4>Python Sequential Example<a class="headerlink" href="#python-sequential-example" title="Permalink to this headline">Â¶</a></h4>
<p>This example not only illustrates how users can directly create a sequential
pass using Python APIs (this could be applied to module- and function-level
passes as well), but also explains how we can build an optimization pipeline
using <code class="docutils literal notranslate"><span class="pre">Sequential</span></code> associated with other types of passes.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span class="c1"># Create a simple Relay program.</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">c_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">TensorType</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="n">c_data</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">tp</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">relay</span><span class="o">.</span><span class="n">const</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;float32&quot;</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="n">z1</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
<span class="n">z2</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">z1</span><span class="p">)</span>
<span class="n">func</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">Function</span><span class="p">([</span><span class="n">x</span><span class="p">],</span> <span class="n">z2</span><span class="p">)</span>

<span class="c1"># Customize the optimization pipeline.</span>
<span class="n">seq</span> <span class="o">=</span> <span class="n">_transform</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">relay</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">InferType</span><span class="p">(),</span>
    <span class="n">relay</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">FoldConstant</span><span class="p">(),</span>
    <span class="n">relay</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">EliminateCommonSubexpr</span><span class="p">(),</span>
    <span class="n">relay</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">AlterOpLayout</span><span class="p">()</span>
<span class="p">])</span>

<span class="c1"># Create a module to perform optimizations.</span>
<span class="n">mod</span> <span class="o">=</span> <span class="n">relay</span><span class="o">.</span><span class="n">Module</span><span class="p">({</span><span class="s2">&quot;main&quot;</span><span class="p">:</span> <span class="n">func</span><span class="p">})</span>

<span class="c1"># Users can disable any passes that they don&#39;t want to execute by providing</span>
<span class="c1"># a list, e.g. disabled_pass=[&quot;EliminateCommonSubexpr&quot;].</span>
<span class="k">with</span> <span class="n">relay</span><span class="o">.</span><span class="n">build_config</span><span class="p">(</span><span class="n">opt_level</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tvm</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;llvm&quot;</span><span class="p">):</span>
        <span class="c1"># Perform the optimizations.</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">seq</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="debugging">
<h3>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">Â¶</a></h3>
<p>The pass infra provides a special pass (<code class="docutils literal notranslate"><span class="pre">PrintIR</span></code>) to dump the IR of the
whole module after applying a certain pass. A slightly modified version of the
sequential pass example could be like the following to enable IR dumping for
<code class="docutils literal notranslate"><span class="pre">FoldConstant</span></code> optimization.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span class="n">seq</span> <span class="o">=</span> <span class="n">_transform</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">relay</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">InferType</span><span class="p">(),</span>
    <span class="n">relay</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">FoldConstant</span><span class="p">(),</span>
    <span class="n">relay</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">PrintIR</span><span class="p">(),</span>
    <span class="n">relay</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">EliminateCommonSubexpr</span><span class="p">(),</span>
    <span class="n">relay</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">AlterOpLayout</span><span class="p">()</span>
<span class="p">])</span>
</pre></div>
</div>
<p>By inserting the <code class="docutils literal notranslate"><span class="pre">PrintIR</span></code> pass after <code class="docutils literal notranslate"><span class="pre">FoldConstant</span></code>, the pass infra will
dump out the module IR when <code class="docutils literal notranslate"><span class="pre">FoldConstant</span></code> is done. Users can plug in this
pass after any pass they want to debug for viewing the optimization effect.</p>
<p>There is a more flexible debugging mechanism also exposed by the build configuration
object. One can pass a tracing function which can be used to execute arbitrary code
before and/or after each pass. A tracing function will receive a <code class="docutils literal notranslate"><span class="pre">IRModule</span></code>, <code class="docutils literal notranslate"><span class="pre">PassInfo</span></code>,
and a boolean indicating whether you are executing before, or after a pass.
An example is below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span class="k">def</span> <span class="nf">print_ir</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">is_before</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print the name of the pass, the IR, only before passes execute.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_before</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Running pass: {}&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>

<span class="k">with</span> <span class="n">relay</span><span class="o">.</span><span class="n">build_config</span><span class="p">(</span><span class="n">opt_level</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">trace</span><span class="o">=</span><span class="n">print_ir</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">tvm</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;llvm&quot;</span><span class="p">):</span>
            <span class="c1"># Perform the optimizations.</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">seq</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
</pre></div>
</div>
<p>For more pass infra related examples in Python and C++, please refer to
<a class="reference external" href="https://github.com/apache/incubator-tvm/blob/master/tests/python/relay/test_pass_manager.py">tests/python/relay/test_pass_manager.py</a> and
<a class="reference external" href="https://github.com/apache/incubator-tvm/blob/master/tests/cpp/relay_transform_sequential.cc">tests/cpp/relay_transform_sequential.cc</a>, respectively.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="relay_add_pass.html" class="btn btn-neutral float-right" title="Adding a Compiler Pass to Relay" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="relay_op_strategy.html" class="btn btn-neutral float-left" title="Relay Operator Strategy" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Apache Software Foundation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-75982049-2', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>